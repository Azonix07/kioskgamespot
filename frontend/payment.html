<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gamespot Kiosk - Payment</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Global Styling */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* Body Styling */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
      text-align: center;
      color: white;
      background: linear-gradient(135deg, #121212, #1e1e2f);
    }

    /* Video Background */
    .video-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -1;
      filter: brightness(0.6) contrast(1.1);
    }

    /* Overlay Styling */
    .overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.75) 0%, rgba(12, 12, 24, 0.9) 100%);
      z-index: 0;
    }

    /* Header */
    .header {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      padding: 10px 15px;
      background: rgba(20, 20, 35, 0.9);
      z-index: 100;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid rgb(255, 111, 0);
    }

    .info-pill {
      background: rgba(30, 30, 47, 0.7);
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 500;
      font-size: 0.8rem;
      border: 1px solid rgba(255, 111, 0, 0.3);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 45%;
    }

    /* Main Container Styling */
    .main-container {
      z-index: 2;
      position: relative;
      width: 90%;
      max-width: 1100px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      padding: 0 15px;
      height: calc(100vh - 40px);
      margin-top: 40px;
    }

    /* Left Column - Payment Details */
    .payment-column {
      flex: 1;
      max-width: 450px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    /* Right Column - Camera */
    .camera-column {
      flex: 1;
      max-width: 450px;
      display: flex;
      flex-direction: column;
    }

    /* Heading Styling */
    h1 {
      color: rgb(255, 111, 0);
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: 1px;
      text-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      position: relative;
      display: inline-block;
      margin-bottom: 5px;
    }

    h2 {
      color: white;
      font-size: 1.3rem;
      margin: 10px 0 5px;
      font-weight: 600;
    }

    /* Payment Details */
    .payment-details {
      background: rgba(30, 30, 47, 0.7);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 111, 0, 0.2);
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-weight: 500;
      color: rgba(255, 255, 255, 0.7);
    }

    .detail-value {
      font-weight: 600;
      color: rgb(255, 111, 0);
    }

    .total-row {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 2px solid rgba(255, 111, 0, 0.3);
      font-size: 1.1rem;
    }

    /* Camera Section */
    .camera-container {
      width: 100%;
      position: relative;
      overflow: hidden;
      border-radius: 10px;
      border: 2px solid rgb(255, 111, 0);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      background-color: #000;
      aspect-ratio: 4/3;
    }

    #cameraFeed, #canvas {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1); /* Mirror effect */
    }

    #canvas {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
    }

    .camera-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10;
    }

    .camera-message {
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
      text-align: center;
      margin-bottom: 15px;
      max-width: 80%;
      line-height: 1.3;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    /* Face Frame */
    .face-outline {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 180px;
      height: 220px;
      border: 3px dashed rgba(255, 111, 0, 0.7);
      border-radius: 50% 50% 45% 45%;
      box-shadow: 0 0 0 2000px rgba(0, 0, 0, 0.3);
      z-index: 5;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      padding-bottom: 15px;
    }

    .face-outline p {
      background: rgba(0, 0, 0, 0.6);
      padding: 4px 8px;
      border-radius: 15px;
      font-size: 0.8rem;
      color: white;
    }

    /* Button Styling */
    .btn {
      padding: 10px 20px;
      font-size: 1rem;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: 0.5s;
    }

    .btn:hover::after {
      left: 100%;
    }

    .btn-orange {
      background: rgb(255, 111, 0);
    }

    .btn-orange:hover {
      background: #ff6b6b;
      transform: translateY(-3px);
    }

    .btn-gray {
      background: #444;
    }

    .btn-gray:hover {
      background: #666;
      transform: translateY(-3px);
    }

    .btn-disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .btn-disabled:hover {
      transform: none;
    }

    .btn-disabled::after {
      display: none;
    }

    /* Payment Methods - LARGER */
    .payment-methods {
      display: flex;
      justify-content: center;
      gap: 25px;
      margin: 15px 0;
    }

    .payment-method {
      background: rgba(30, 30, 47, 0.7);
      padding: 20px 30px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 140px;
    }

    .payment-method:hover {
      border-color: rgb(255, 111, 0);
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }

    .payment-method.selected {
      border-color: rgb(255, 111, 0);
      background: rgba(255, 111, 0, 0.2);
    }

    .payment-method img {
      height: 60px;
      width: auto;
      margin-bottom: 10px;
    }

    .payment-method-name {
      font-weight: 600;
      font-size: 1.1rem;
      margin-top: 10px;
    }

    /* Status Messages */
    .status-message {
      padding: 8px 15px;
      border-radius: 6px;
      margin: 10px 0;
      font-weight: 500;
      font-size: 0.9rem;
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .error {
      background: rgba(255, 0, 0, 0.2);
      border: 1px solid #f44336;
      color: #ff9999;
    }

    .success {
      background: rgba(0, 128, 0, 0.2);
      border: 1px solid #4CAF50;
      color: #99ff99;
    }

    .info {
      background: rgba(0, 0, 255, 0.2);
      border: 1px solid #2196F3;
      color: #99ccff;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 111, 0, 0.3);
      border-radius: 50%;
      border-top-color: rgb(255, 111, 0);
      animation: spin 1s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Navigation buttons */
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
      width: 100%;
      gap: 15px;
    }

    /* Responsive Adjustments */
    @media (max-width: 900px) {
      .main-container {
        flex-direction: column;
        gap: 15px;
        padding-top: 10px;
        padding-bottom: 10px;
        overflow-y: auto;
        height: auto;
        margin-top: 50px;
      }
      
      .payment-column, .camera-column {
        max-width: 100%;
      }
      
      h1 {
        font-size: 1.7rem;
      }
      
      h2 {
        font-size: 1.2rem;
        margin: 5px 0;
      }
      
      .camera-container {
        aspect-ratio: 16/9;
        max-height: 200px;
      }
    }
  </style>
</head>
<body>
  <!-- Header with Date and User -->
  <div class="header">
    <div class="info-pill" id="current-date">Current Date and Time (UTC - YYYY-MM-DD HH:MM:SS formatted): 2025-07-19 14:10:36</div>
    <div class="info-pill" id="current-user">Current User's Login: Azonix07</div>
  </div>

  <!-- Video Background -->
  <video class="video-background" autoplay muted loop>
    <source src="background.mp4" type="video/mp4">
    Your browser does not support the video tag.
  </video>

  <!-- Overlay -->
  <div class="overlay"></div>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Left Column - Payment Details -->
    <div class="payment-column">
      <h1>Complete Payment</h1>
      
      <!-- Payment Details -->
      <div class="payment-details">
        <div class="detail-row">
          <div class="detail-label">Device:</div>
          <div class="detail-value" id="selectedConsole">PS5</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Duration:</div>
          <div class="detail-value" id="selectedDuration">60 minutes</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Base Price:</div>
          <div class="detail-value" id="basePrice">₹250</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Controllers:</div>
          <div class="detail-value" id="controllerDetails">1 × ₹50</div>
        </div>
        <div class="detail-row total-row">
          <div class="detail-label">Total Amount:</div>
          <div class="detail-value" id="totalAmount">₹300</div>
        </div>
      </div>
      
      <h2>Select Payment Method</h2>
      
      <!-- Payment Methods - Only Cash and UPI -->
      <div class="payment-methods">
        <div class="payment-method" data-method="cash">
          <img src="https://cdn-icons-png.flaticon.com/512/2489/2489756.png" alt="Cash">
          <div class="payment-method-name">Cash</div>
        </div>
        <div class="payment-method" data-method="upi">
          <img src="https://upload.wikimedia.org/wikipedia/commons/e/e1/UPI-Logo-vector.svg" alt="UPI">
          <div class="payment-method-name">UPI</div>
        </div>
      </div>
      
      <!-- Status Message -->
      <div id="statusMessage" class="status-message info" style="display: none;"></div>
      
      <!-- Navigation Buttons -->
      <div class="nav-buttons">
        <button class="btn btn-gray" id="backBtn">Back</button>
        <button class="btn btn-orange btn-disabled" id="payBtn" disabled>Pay Now</button>
      </div>
    </div>
    
    <!-- Right Column - Camera -->
    <div class="camera-column">
      <h2>Verification Photo</h2>
      <p style="font-size: 0.9rem; margin-bottom: 10px;">Position your face in the frame for verification</p>
      
      <!-- Camera Section -->
      <div class="camera-container">
        <video id="cameraFeed" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <div class="face-outline">
          <p>Position your face here</p>
        </div>
        
        <!-- Camera loading message -->
        <div class="camera-overlay" id="cameraOverlay">
          <div class="camera-message">
            Camera activating... <div class="loading-spinner" style="display: inline-block;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let stream = null;
    let selectedPaymentMethod = null;
    
    // DOM elements
    const cameraFeed = document.getElementById('cameraFeed');
    const canvas = document.getElementById('canvas');
    const cameraOverlay = document.getElementById('cameraOverlay');
    const payBtn = document.getElementById('payBtn');
    const backBtn = document.getElementById('backBtn');
    const statusMessage = document.getElementById('statusMessage');
    const paymentMethods = document.querySelectorAll('.payment-method');

    // Initialize payment details from local storage
    function initPaymentDetails() {
      // Get console information
      const consoleName = localStorage.getItem('selectedConsole') || 'PS5';
      
      // Get duration information
      const duration = localStorage.getItem('selectedDuration') || '60';
      const durationMin = parseInt(duration);
      
      // Get base price
      const basePrice = localStorage.getItem('selectedPrice') || '250';
      
      // Get controllers information
      const controllers = localStorage.getItem('selectedControllers') || '1';
      const controllerPrice = localStorage.getItem('controllerPrice') || '50';
      const controllerTotal = parseInt(controllers) * parseInt(controllerPrice);
      
      // Calculate total price
      const totalPrice = localStorage.getItem('totalPrice') || 
                         (parseInt(basePrice) + controllerTotal).toString();

      // Update UI
      document.getElementById('selectedConsole').textContent = consoleName;
      document.getElementById('selectedDuration').textContent = `${durationMin} minutes`;
      document.getElementById('basePrice').textContent = `₹${basePrice}`;
      document.getElementById('controllerDetails').textContent = `${controllers} × ₹${controllerPrice}`;
      document.getElementById('totalAmount').textContent = `₹${totalPrice}`;
    }

    // Auto-initialize camera as soon as the page loads
    async function initCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            width: { ideal: 1280 },
            height: { ideal: 720 },
            facingMode: "user"
          } 
        });
        
        cameraFeed.srcObject = stream;
        cameraOverlay.style.display = 'none';
        
        showStatusMessage('Camera activated. Select payment method to continue.', 'info');
      } catch (err) {
        console.error('Camera error:', err);
        cameraOverlay.innerHTML = `
          <div class="camera-message">
            Camera error: ${err.message}<br>Please allow camera access to continue.
          </div>
        `;
        showStatusMessage(`Camera error: ${err.message}. Please allow camera access.`, 'error');
      }
    }

    // Improved capturePhoto function that actually returns the photo data
    function capturePhoto() {
      try {
        const context = canvas.getContext('2d');
        
        // Make sure the video is ready
        if (cameraFeed.videoWidth === 0 || cameraFeed.videoHeight === 0) {
          return null; // Camera not ready yet
        }
        
        // Set canvas dimensions
        canvas.width = cameraFeed.videoWidth * 0.5;  // 50% of original size
        canvas.height = cameraFeed.videoHeight * 0.5;
        
        // Draw the video frame to the canvas (and flip it horizontally)
        context.translate(canvas.width, 0);
        context.scale(-1, 1);
        context.drawImage(cameraFeed, 0, 0, cameraFeed.videoWidth, cameraFeed.videoHeight, 
                         0, 0, canvas.width, canvas.height);
        
        // Return the data URL of the image
        return canvas.toDataURL('image/jpeg', 0.7);
      } catch (err) {
        console.error("Error capturing photo:", err);
        return null;
      }
    }

    // Add click event listeners to payment methods
    document.querySelectorAll('.payment-method').forEach(method => {
      method.onclick = function() {
        // Remove selected class from all methods
        document.querySelectorAll('.payment-method').forEach(m => {
          m.classList.remove('selected');
        });
        
        // Add selected class to this method
        this.classList.add('selected');
        
        // Set the selected payment method
        selectedPaymentMethod = this.getAttribute('data-method');
        
        // Enable the pay button if we have a camera stream
        if (stream && stream.active) {
          payBtn.disabled = false;
          payBtn.classList.remove('btn-disabled');
        }
        
        showStatusMessage(`Selected payment method: ${selectedPaymentMethod}`, 'info');
      };
    });

    // Handle payment - Store photo and simulate payment
    payBtn.addEventListener('click', async () => {
      if (!stream || !stream.active) {
        showStatusMessage('Please enable your camera first.', 'error');
        return;
      }
      
      if (!selectedPaymentMethod) {
        showStatusMessage('Please select a payment method first.', 'error');
        return;
      }
      
      // Disable button and show loading state
      payBtn.disabled = true;
      payBtn.innerHTML = 'Processing <div class="loading-spinner"></div>';
      
      try {
        // Get payment details
        const consoleName = document.getElementById('selectedConsole').textContent;
        const durationText = document.getElementById('selectedDuration').textContent;
        const durationMinMatch = durationText.match(/\d+/);
        
        if (!durationMinMatch) {
          throw new Error('Could not determine duration');
        }
        
        const durationMin = parseInt(durationMinMatch[0]);
        
        // Capture the photo for storage
        const photoDataUrl = capturePhoto();
        
        console.log('Simulating payment:', {
          console: consoleName,
          minutes: durationMin,
          method: selectedPaymentMethod,
          hasPhoto: !!photoDataUrl
        });
        
        // Wait a bit to simulate processing
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Calculate end time for booking
        const endTime = Date.now() + (durationMin * 60 * 1000);
        
        // Create unique ID for this booking
        const bookingId = `${consoleName}-${endTime}`;
        
        // Store the photo if captured successfully
        if (photoDataUrl) {
          // Get existing photos or create new object
          const photosJSON = localStorage.getItem('userPhotos') || '{}';
          let photos;
          try {
            photos = JSON.parse(photosJSON);
          } catch (e) {
            photos = {};
          }
          
          // Store the new photo with the booking ID as key
          photos[bookingId] = photoDataUrl;
          localStorage.setItem('userPhotos', JSON.stringify(photos));
          console.log('Photo stored for booking:', bookingId);
        }
        
        // Store booking in the new multi-booking format
        const newBooking = {
          console: consoleName,
          endTime: endTime,
          minutes: durationMin,
          method: selectedPaymentMethod,
          controllers: localStorage.getItem('selectedControllers') || '1'
        };
        
        // Use storage event to communicate between tabs
        localStorage.setItem('newBooking', JSON.stringify(newBooking));
        
        // Also store directly in consoleBookings
        const bookingsJSON = localStorage.getItem('consoleBookings') || '[]';
        let bookings = JSON.parse(bookingsJSON);
        
        // Remove any existing booking for this console
        bookings = bookings.filter(b => b.console !== consoleName);
        
        // Add the new booking
        bookings.push(newBooking);
        
        // Save updated bookings
        localStorage.setItem('consoleBookings', JSON.stringify(bookings));
        
        // Show success message
        showStatusMessage('Payment successful! Redirecting to main screen...', 'success');
        
        // Stop camera stream
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }
        
        // Redirect after a delay
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);
        
      } catch (err) {
        console.error('Payment error:', err);
        showStatusMessage(`Payment error: ${err.message}. Please try again.`, 'error');
        
        // Reset button state
        payBtn.innerHTML = 'Pay Now';
        payBtn.disabled = false;
      }
    });

    // Back button handler
    backBtn.addEventListener('click', () => {
      // Stop camera stream if it's active
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      
      // Go back to duration selection
      window.location.href = 'duration.html';
    });

    // Show status message
    function showStatusMessage(message, type) {
      statusMessage.textContent = message;
      statusMessage.className = `status-message ${type}`;
      statusMessage.style.display = 'block';
      
      // Hide after 5 seconds
      setTimeout(() => {
        statusMessage.style.display = 'none';
      }, 5000);
    }

    // Initialize page
    function init() {
      // Set static date and time
      document.getElementById('current-date').textContent = "Current Date and Time (UTC - YYYY-MM-DD HH:MM:SS formatted): 2025-07-19 14:10:36";
      document.getElementById('current-user').textContent = "Current User's Login: Azonix07";
      
      initPaymentDetails();
      // Automatically initialize the camera
      initCamera();
    }

    // Start initialization when page loads
    window.onload = init;
  </script>
</body>
</html>